{{define "base"}}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{if .Title}}{{.Title}} - {{end}}Gatecrash</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <link rel="stylesheet" href="/static/fonts/roboto/roboto.css">
    <link rel="stylesheet" href="/static/css/app.css">
    <script defer src="/static/js/alpine.js"></script>
</head>
<body class="bg-gray-50 text-gray-900 text-[13px] leading-tight min-h-screen flex flex-col">
    {{if .Active}}
    <nav class="bg-gray-800 text-white" x-data="{ mobileMenu: false }">
        <div class="max-w-full mx-auto px-4 flex items-center h-10">
            <a href="/" class="font-bold text-base mr-6 hover:text-gray-200">Gatecrash</a>
            <!-- Desktop nav links -->
            <div class="hidden md:flex items-center gap-1">
                <a href="/" class="px-3 py-1 rounded text-sm {{if eq .Active "dashboard"}}bg-gray-600 font-semibold{{else}}hover:bg-gray-700{{end}}">Dashboard</a>
                <a href="/passkeys" class="px-3 py-1 rounded text-sm {{if eq .Active "passkeys"}}bg-gray-600 font-semibold{{else}}hover:bg-gray-700{{end}}">Passkeys</a>
                <a href="/help" class="px-3 py-1 rounded text-sm {{if eq .Active "help"}}bg-gray-600 font-semibold{{else}}hover:bg-gray-700{{end}}">Help</a>
            </div>
            <!-- Desktop right controls -->
            <div class="ml-auto hidden md:flex items-center gap-3">
                <div x-data="updateBanner()" x-init="init()" x-cloak>
                    <template x-if="available && !isDocker">
                        <button @click="doUpdate()" :disabled="updating"
                                class="text-xs bg-green-500 hover:bg-green-400 px-2 py-1 rounded font-medium disabled:opacity-50"
                                x-text="updating ? 'Updating...' : 'Update to v' + latest"></button>
                    </template>
                </div>
                <span class="text-xs bg-gray-700 px-2 py-0.5 rounded">v{{.Version}}</span>
                <form method="POST" action="/logout">
                    <button type="submit" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded">Logout</button>
                </form>
            </div>
            <!-- Hamburger button -->
            <button @click="mobileMenu = !mobileMenu" class="ml-auto md:hidden p-1 rounded hover:bg-gray-700">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path x-show="!mobileMenu" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                    <path x-show="mobileMenu" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <!-- Mobile dropdown -->
        <div x-show="mobileMenu" x-transition @click.outside="mobileMenu = false" class="md:hidden border-t border-gray-700 px-4 py-2 flex flex-col gap-1">
            <a href="/" class="px-3 py-2 rounded text-sm {{if eq .Active "dashboard"}}bg-gray-600 font-semibold{{else}}hover:bg-gray-700{{end}}">Dashboard</a>
            <a href="/passkeys" class="px-3 py-2 rounded text-sm {{if eq .Active "passkeys"}}bg-gray-600 font-semibold{{else}}hover:bg-gray-700{{end}}">Passkeys</a>
            <a href="/help" class="px-3 py-2 rounded text-sm {{if eq .Active "help"}}bg-gray-600 font-semibold{{else}}hover:bg-gray-700{{end}}">Help</a>
            <div class="border-t border-gray-700 mt-1 pt-2 flex items-center gap-3">
                <div x-data="updateBanner()" x-init="init()" x-cloak>
                    <template x-if="available && !isDocker">
                        <button @click="doUpdate()" :disabled="updating"
                                class="text-xs bg-green-500 hover:bg-green-400 px-2 py-1 rounded font-medium disabled:opacity-50"
                                x-text="updating ? 'Updating...' : 'Update to v' + latest"></button>
                    </template>
                </div>
                <span class="text-xs bg-gray-700 px-2 py-0.5 rounded">v{{.Version}}</span>
                <form method="POST" action="/logout" class="ml-auto">
                    <button type="submit" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded">Logout</button>
                </form>
            </div>
        </div>
    </nav>
    {{end}}

    <main class="flex-1 p-3 max-w-full mx-auto w-full">
        {{if .Flash}}
        <div x-data="{show: true}" x-show="show" x-transition
             class="mb-3 px-4 py-2 rounded text-sm flex items-center gap-2 {{if eq .Flash.Type "success"}}bg-green-50 text-green-800 border border-green-200{{else if eq .Flash.Type "warning"}}bg-amber-50 text-amber-800 border border-amber-200{{else}}bg-red-50 text-red-800 border border-red-200{{end}}">
            <span class="flex-1">{{.Flash.Message}}</span>
            <button @click="show = false" class="text-lg leading-none opacity-50 hover:opacity-100">&times;</button>
        </div>
        {{end}}
        {{template "content" .}}
    </main>

    <footer class="py-2 text-center text-xs text-gray-400">
        <a href="https://github.com/jclement/gatecrash" target="_blank" class="hover:text-gray-600">Gatecrash</a> v{{.Version}}
    </footer>

    {{if .Active}}
    <script>
    function updateBanner() {
        return {
            available: false,
            latest: '',
            isDocker: false,
            updating: false,
            init() {
                this.checkUpdate();
            },
            async checkUpdate() {
                try {
                    const resp = await fetch('/api/update');
                    if (!resp.ok) return;
                    const data = await resp.json();
                    this.available = data.available;
                    this.latest = data.latest;
                    this.isDocker = data.is_docker;
                } catch (_) {}
            },
            async doUpdate() {
                if (!confirm('Update to v' + this.latest + '? The server will restart.')) return;
                this.updating = true;
                try {
                    const resp = await fetch('/api/update', { method: 'POST' });
                    if (!resp.ok) {
                        alert('Update failed: ' + await resp.text());
                        this.updating = false;
                        return;
                    }
                    // Server will restart â€” show message and wait for reconnect
                    document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:sans-serif;color:#666"><div style="text-align:center"><p style="font-size:18px;margin-bottom:8px">Updating to v' + this.latest + '...</p><p>The server is restarting. This page will reload automatically.</p></div></div>';
                    const poll = setInterval(async () => {
                        try {
                            const r = await fetch('/health');
                            if (r.ok) { clearInterval(poll); location.reload(); }
                        } catch (_) {}
                    }, 2000);
                } catch (e) {
                    alert('Update failed: ' + e.message);
                    this.updating = false;
                }
            }
        };
    }
    </script>
    {{end}}
</body>
</html>
{{end}}
