version: 2
project_name: gatecrash

before:
  hooks:
    - go mod tidy

builds:
  - id: gatecrash
    main: ./cmd/gatecrash
    binary: gatecrash
    env: [CGO_ENABLED=0]
    goos: [linux, darwin, windows]
    goarch: [amd64, arm64]
    ldflags:
      - -s -w -X main.Version={{.Version}}

archives:
  - id: gatecrash
    builds: [gatecrash]
    name_template: "gatecrash_{{ .Os }}_{{ .Arch }}"
    format: binary

dockers:
  - ids: [gatecrash]
    goos: linux
    goarch: amd64
    dockerfile: Dockerfile.goreleaser
    use: buildx
    build_flag_templates: ["--platform=linux/amd64"]
    image_templates:
      - "ghcr.io/jclement/gatecrash:{{ .Version }}-amd64"
      - "ghcr.io/jclement/gatecrash:latest-amd64"

  - ids: [gatecrash]
    goos: linux
    goarch: arm64
    dockerfile: Dockerfile.goreleaser
    use: buildx
    build_flag_templates: ["--platform=linux/arm64"]
    image_templates:
      - "ghcr.io/jclement/gatecrash:{{ .Version }}-arm64"
      - "ghcr.io/jclement/gatecrash:latest-arm64"

docker_manifests:
  - name_template: "ghcr.io/jclement/gatecrash:{{ .Version }}"
    image_templates:
      - "ghcr.io/jclement/gatecrash:{{ .Version }}-amd64"
      - "ghcr.io/jclement/gatecrash:{{ .Version }}-arm64"
  - name_template: "ghcr.io/jclement/gatecrash:latest"
    image_templates:
      - "ghcr.io/jclement/gatecrash:latest-amd64"
      - "ghcr.io/jclement/gatecrash:latest-arm64"

changelog:
  sort: asc
  filters:
    exclude: ["^docs:", "^test:", "^ci:", "^chore:"]

release:
  prerelease: auto
  footer: |
    ## Docker

    ```bash
    docker pull ghcr.io/jclement/gatecrash:{{ .Version }}
    ```

    ## Quick Install (Linux)
    ```bash
    curl -fsSL https://raw.githubusercontent.com/jclement/gatecrash/main/deploy/install.sh | sh
    ```
